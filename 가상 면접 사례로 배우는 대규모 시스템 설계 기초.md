# 서평
- 이 책의 목적은 시스템 설계 면접 문제를 푸는 데 안정적으로 적용할 수 있는 전략을 제시하는 것으로 규모 확장성을 갖춘 시스템을 만들기 위 해 필수적인 지식도 제공하고 있습니다. 이 책에서는 시스템 설계 면접 문제들을 공략하는 단계적 접근법도 다루고 있어서 해당 접근법을 실제로 따라하면서 배울 수 있도록 많은 예제를 상세한 설명과 함께 제공하고 있어서 좋았습니다. 

# 사용자 수에 따른 규모 확장
- 규모 확장성과 관계된 설계 문제를 푸는 데 쓰일 유용한 지식들을 배울 수 있습니다.
- 단일 서버
  - 실제 요청
    - 웹 애플리케이션 : 비즈니스 로직, 데이터 저장 등을 처리하기 위해서는 서버 구현용 언어(자바, 파이썬 등)를 사용하고, 프레젠테이션용으로는 클라이언트 구현용 언어(HTML, 자바스크립트 등)를사용함 
    - 모바일 앱 : 모바일 앱과 웹 서버 간 통신을 위해서는 HTTP 프로토콜을 이용함. HTTP 프로토콜을 통해서 반환될 응답 데이터의 포맷으로는 보통 JSON(JavaScript Object Notation)이 그 간결함 덕에 널리 쓰임 
- 데이터 베이스
  - 사용자가 늘면 서버 하나로는 충분하지 않아서 여러 서버를 두어야 함. 하나는 웹/모바일 트래픽 처리 용도고, 다른 하나는 데이터베이스용. 웹/모바일 트래픽 처리 서버(웹 계층)와 데이터베이스 서버(데이터 계층)를 분리하면 그 각각을 독립적으로 확장해 나갈 수 있게 됨 
  - 어떤 데이터베이스를 사용할 것인가?
    - 관계형 데이터베이스는 관계형 데이터베이스 관리 시스템(Relational Data-base Management System,RDBMS). RDBMS 가운데 가장 유명한 것으로는 MySQL, 오라클 데이터베이스, PostgreSQL 등이 있음. 관계형 데이터베이스는 자료를 테이블과 열, 칼럼으로 표현함 
    - 비 관계형 데이터베이스는 NoSQL으로 대표적인 것으로는 CouchDB, Neo4j, Cassandra, HBase, Amazon DynamoDB 등이 있음. 
    - NOSQL은 다시 네 분류로 나눠짐. 키 값 저장소, 그래프 저장소, 칼럼 저장소, 문서저장소. 비-관계형 데이터베이스는 일반적으로 조인 연산은 지원하지 않음 
    - 비-관계형 데이터베이스가 바람직한 선택일 경우
      - 아주 낮은 응답 지연시간(latency)이 요구됨
      - 다루는 데이터가 비정형(unstructured)이라 관계형 데이터가 아님
      - 데이터(JSON, YAML, XML 등)를 직렬화하거나(serialize) 역직렬화(deserial-ize) 할 수 있기만 하면 됨 
      - 아주 많은 양의 데이터를 저장할 필요가 있음 
- 수직적 규모 확장 vs 수평적 규모 확장
  - 스케일 업, 수직적 규모 확장(vertical scaling) 프로세스는 서버에 고사양 자원(더 좋은 CPU, 더 많은 RAM 등)을 추가하는 행위를 말함 
  - 스케일 아웃이라고도 하는 수평적 규모 확장 프로세스는 더 많은 서버를 추가하여 성능을 개선하는 행위를 말함
  - 서버로 유입되는 트래픽의 양이 적을 때는 수직적 확장이 좋은 서택이며 가장 큰 장점은 단순함. 단점은 다음과 같음
    - 수직적 규모 확장에는 한계가 있음. 한 대의 서버에 CPU나 메모리를 무한대로 증설할 방법은 없음
    - 수직적 규모 확장법은 장애에 대한 자동복구(failover) 방안이나 다중화(re-dundancy) 방안을 제시하지 않음. 서버에 장애가 발생하면 웹사이트/앱은 완전히 중단됨 
  - 대규모 애플리케이션을 지원하는 데는 수평적 규모 확장법이 보다 적절함 
  - 로드 밸런서 
    - 로드밸런서는 부하 분산 집합(load balancing set)에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 함 
    - 사용자는 로드밸런서의 공개 IP 주소 (public IP address)로 접속함
    - 웹 서버는 클라이언트의 접속을 직접 처리하지 않음. 더 나은 보안을 위해, 서버 간 통신에는 사설 IP 주소(private IP address)가 이용됨. 사설 IP 주소는 같은 네트워크에 속한 서버 사이의 통신에만 쓰일 수 있는 IP주소로, 인터넷을 통해서는 접속할 수 없음. 로드밸런서는 웹 서버와 통신하기 위해 바로 이 사설 주소를 이용함 
    - 부하 분산 집합에 또 하나의 웹 서버를 추가하고 나면 장애를 자동복구하지 못하는 문제(no failover)는 해소되며, 웹 계층의 가용성(availability)은 향상됨 
      - 서버 1이 다운되면(offline) 모든 트래픽은 서버 2로 전송됨. 웹 사이트 전체가 다운되는 일이 방지됨. 부하를 나누기 위해 새로운 서버를 추가할 수도 있음 
      - 웹사이트로 유입되는 트래픽이 가파르게 증가하면 두 대의 서버로 트래픽을 감당할 수 없는 시점이 오는데, 로드밸런서가 있으므로 우아하게 대처할 수 있음. 웹 서버 계층에 더 많은 서버를 추가하기만 하면 됨. 로드밸런스가 자동적으로 트래픽을 분산하기 시작함 
  - 데이터베이스 다중화 
    - 많은 데이터베이스 관리 시스템이 다중화를 지원함. 보통은 서버 사이에 주(master)-부(slave) 관계를 설정하고 데이터 원본은 주서버에, 사본은 부 서버에 저장하는 방식
    - 쓰기 연산(write operation)은 마스터에서만 지원함. 부 데이터베이스는 주 데이터베이스로부터 그 사본을 전달받으며, 읽기 연산(read operation)만을 지원함.
    - 데이터베이스를 변경하는 명령어들, 가령 insert, delete, update 등은 주 데이터베이스로만 전달되어야 함 
    - 대부분의 애플리케이션은 읽기 연산의 비중이 쓰기 연산보다 훨씬 높음 
    - 이점
      - 더 나은 성능 
        - 주-부 다중화 모델에서 모든 데이터 변경 연산은 주 데이터베이스 서버로만 전달되는 반면 읽기 연산은 부 데이터베이스 서버들로 분산됨.
        - 병렬로 처리될 수 있는 질의(query)의 수가 늘어나므로, 성능이 좋아짐 
      - 안정성(reliability)
        - 자연 재해 등의 이유로 데이터베이스 서버 가운데 일부가 파괴되어도 데이터는 보존될 것
        - 데이터를 지역적으로 떨어진 여러 장소에 다중화시켜 놓을 수 있기 때문
      - 가용성(availability)
        - 데이터를 여러 지역에 복제해 둠으로써, 하나의 데이터베이스 서버에 장애가 발생하더라도 다른 서버에 있는 데이터를 가져와 계속 서비스할 수 있게 됨 
    - 응답 시간은 캐시를 붙이고 정적 콘텐츠를 콘텐츠 전송 네트워크(Content Delivery Network, CDN)로 옮기면 개선할 수 있음 
- 캐시 
  - 캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소
  - 캐시 계층
    - 캐시 계층(cache tier)은 데이터가 잠시 보관되는 곳으로, 데이터베이스보다 훨씬 빠름. 별도의 캐시 계층을 두면 성능이 개선될 뿐 아니라 데이터베이스의 부하를 줄일 수 있고, 캐시 계층의 규모를 독립적으로 확장시키는 것도 가능해짐 
    - 캐시 사용시 유의할 점
      - 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어난다면 고려해볼 만 ㅎ마 
      - 캐시는 데이터를 휘발성 메모리에 두므로, 영속적으로 보관할 데이터를 캐시에 두는 것은 바람직하지 않음. 캐시 서버가 재시작되면 캐시 내의 모든 데이터는 사라짐 
      - 만료된 데이터는 캐시에서 삭제되어야 함 
      - 일관성은 데이터 저장소의 원본과 캐시 내의 사본이 같은지 여부. 저장소의 원본을 갱신하는 연산과 캐시를 갱신하는 연산이 단일 트랜잭션으로 처리되지 않는 경우 이 일관성은 깨질 수 있음 
      - 캐시 서버를 한 대만 두는 경우 해당 서버는 단일 장애 지점(Single Point of Failure, SPOF)이 되어버릴 가능성이 있음 
      - 캐시 메모리가 너무 작으면 액세스 패턴에 따라서 데이터가 너무 자주 캐시에서 밀려나버려(eviction) 캐시의 성능이 떨어지게 됨. 이를 막을 한 가지 방법은 캐시 메모리를 과할당(overprovision)하는 것 
      - 캐시가 꽉 차버리면 추가록 캐시에 데이터를 넣어야 할 경우 기존 데이터를 내보내야 함. 캐시 데이터 방출 정책이라고 함. 그 가운데 가장 널리 쓰이는 것은 LRU(Least Recently Used - 마지막으로 사용된 시점이 가장 오래된 데이터를 내보내는 정책). 다른 정책으로는 LFU(Least Freqeuntly Used - 사용된 빈도가 가장 낮은 데이터를 내보내는 정책)이나 FIFO(First In First Out - 가장 먼저 캐시에 들어온 데이터를 가장 먼저 내보내는 정책) 
- 콘텐츠 전송 네트워크(CDN)
  - CDN은 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크. 이미지, 비디오, CSS, JavaScript 파일 등을 캐시할 수 있음 
  - 요청 경로(request path), 질의 문자열(query string), 쿠키(cookie), 요청 헤더(requeset header) 등의 정보에 기반하여 HTML 페이지를 캐시하는 것 
  - 고려해야 할 사항
    - 비용 
      - CDN은 보통 제3 사업자(third-party providers)에 의해 운영되며, 여러분은 CDN으로 들어가고 나가는 데이터 전송 양에 따라 요금을 내게 됨 
    - 적절한 만료 시한 설정
      - 시의성이 중요한(time-sensitive) 콘텐츠의 경우 만료 시점을 잘 정해야 함 
    - CDN 장애에 대한 대처 방안 
      - CDN 자체가 죽었을 경우 웹사이트/애플리케이션이 어떻게 동작해야 하는지 고려해야 함 
    - 콘텐츠 무효화(invalidation)
- 무상태(stateless) 웹 계층 
  - 상태 정보(사용자 세션 데이터와 같은)를 관계형 데이터베이스나 NoSQL 같은 지속성 저장소에 보관하고, 필요할 때 가져오도록 하는 것. 
  - 상태 정보 의존적인 아키텍처
    - 상태 정보를 보관하는 서버는 클라이언트 정보, 즉 상태를 유지하여 요청들 사이에 공유되도록 함. 무상태 서버에는 이런 장치가 없음 
  - 무상태 아키텍처
    - 세션 데이터를 웹 계층에서 분리하고 지속성 데이터 보관소 저장하도록 만들었음. 이 공유 저장소는 관계형 데이터베이스일 수도 있고, Memcached/Redis 같은 캐시 시스템일 수도 있으며 , NoSQL일 수도 있음 .
    - NoSQL을 사용하였는데, 규모 확장이 간편해서. 자동 규모 확장은 트래픽 양에 따라 웹 서버를 자동으로 추가하거나 삭제하는 기능을 뜻함 
- 데이터 센터
  - 장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내되는데, 통상 이 절차를 지리적 라우팅(geoDNS-routing 또는 geo-routing)
  - 지리적 라우팅에서의 geoDNS는 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할지 결정할 수 있도록 해 주는 DNS 서비스 
  - 다중 데이터센터 아키텍처를 만들려면 몇 가지 기술적 난제를 해결해야 함 
    - 트래픽 우회: 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야 함 
    - 데이터 동기화(synchronization) : 데이터 센터마다 별도의 데이터베이스를 사용하고 있는 상황이라면, 장애가 자동으로 복귀되어 트래픽이 다른 데이터베이스로 우회된다 해도, 해당 데이터센터에는 찾는 데이터가 없을 수 있음. 이런 상황을 막는 보편적 전략은 데이터를 여러 데이터 센터에 걸쳐 다중화하는 것 
    - 테스트와 배포(deployment) : 자동화된 배포 도구는 모든 데이터 센터에 동일한 서비스가 설치되도록 하는 데 중요한 역할을 함 
- 메시지 큐 
  - 메시지 큐는 메시지의 무손실(durability, 즉 메시지 큐에 일단 보관된 메시지는 소비자가 꺼낼 때까지 안전히 보관된다는 특성)을 보장하는, 비동기 통신(asynchronous communication)을 지원하는 컴포넌트. 메시지의 버퍼 역할을 하며, 비동기적으로 전송함 
  - 생산자 또는 발행자(producer/publisher)라고 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 발행(publish)함. 큐에는 보통 소비자 혹은 구독자(consumer/subscriber)라 불리는 서비스 혹은 서버가 연결되어 있는데, 메시지를 받아 그에 맞는 동작을 수행하는 역할을 함 
  - 메시지 큐를 이용하면 서비스 또는 서버 간 결합이 느슨해져서, 규모 확장성이 보장되어야 하는 안정적 애플리케이션을 구성하기도 좋음. 생산자는 소비자 프로세스가 다운되어 있어도 메시지를 발행할 수 있고, 소비자는 생산자 서비스가 가용한 상태가 아니더라도 메시지를 수신할 수 있음 
- 로그, 메트릭 그리고 자동화
  - 로그 : 에러 로그를 모니터링하는 것은 중요함. 시스템의 오류와 문제들을 보다 쉽게 찾아낼 수 있도록 하기 때문 
  - 메트릭 : 메트릭을 잘 수집하면 사업 현황에 관한 유용한 정보를 얻을 수도 있고, 시스템의 현재 상태를 손쉽게 파악할 수도 있음 
    - 호스트 단위 메트릭 : CPU, 메모리, 디스크 I/O에 관한 메트릭 
    - 종합(aggregated) 메트릭 : 데이터베이스 계층의 성능, 캐시 계층의 성능
    - 핵심 비즈니스 메트릭 : 일별 능동 사용자(daily active user), 수익(revenue), 재방문(retention)
  - 자동화
    - 시스템이 크고 복잡해지면 생산성을 높이기 위해 자동화 도구를 활용해야 함. 지속적 통합을 도와주는 도구를 활용하면 개발자가 만드는 코드가 어떤 검증 절차를 자동으로 거치도록 할 수 있어서 문제를 쉽게 감지할 수 있음 
    - 빌드, 테스트, 배포 등의 절차를 자동화할 수 있어서 개발 생산성을 크게 향상시킬 수 있음 
- 데이터베이스 규모 확장
  - 수직적 확장
    - 스케일 업이라고도 부르는 수직적 규모 확장법은 기존 서버에 더 많은, 또는 고성능의 자원(CPU, RAM, 디스크 등)을 증설하는 방법.
    - 몇 가지 심각한 약점
      - 데이터베이스 서버 하드웨어에는 한계가 있으므로 CPU, RAM 등을 무한 증설할 수는 없음 
      - SPOF로 인한 위험성이 큼
      - 비용이 많이 듬. 고성능 서버로 갈수록 가격이 올라가게 마련 
  - 수평적 확장
    - 데이터베이스의 수평적 확장은 샤딩(sharding)이라고도 부르는데, 더 많은 서버를 추가함으로써 성능을 향상시킬 수 있도록 함 
    - 샤딩은 대규모 데이터베이스를 샤드(shard)라고 부르는 작은 단위로 분할하는 기술을 일컫는다. 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없음 
    - 샤딩 전략을 구현할 때 고려해야 할 가장 중요한 것은 샤딩 키를 어떻게 정하느냐 하는 것. 샤딩 키는 파티션 키라고도 부르는데, 데이터가 어떻게 분산될지 정하는 하나 이상의 칼럼으로 굿어됨 
    - 샤딩 키를 정할 때는 데이터를 고르게 분할 할 수 있도록 하는 게 가장 중요함 
    - 샤딩을 도입하면 시스템이 복잡해지고 풀어야 할 새로운 문제도 생김
      - 데이터의 재 샤딩(resharding)
        - 데이터가 너무 많아져서 하나의 샤드로는 더 이상 감당하기 어려울 때, 샤드 간 데이터 분포가 균등하지 못하여 어떤 샤드에 할당된 공간 소모가 다른 샤드에 비해 빨리 진행될 때, 샤드 소진(shard exhaustion)이라고도 부르는 이러한 현상이 발생하면 샤드 키를 계산하는 함수를 변경하고 데이터를 재배치하여야 함 
        - 유명인사(celebrity) 문제 : 핫스파 킷 문제라고도 부르는데, 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제
        - 조인과 비정규화(join and de-normalization) : 일단 하나의 데이터베이스를 여러 샤드 서버로 쪼개고 나면, 여러 샤드에 걸친 데이터를 조인하기가 힘들어짐. 데이터베이스를 비정규화하여 하나의 테이블에서 질의가 수행될 수 있도록 하는 것 
        - 데이터베이스 샤딩을 적용한 아키텍처
          - 데이터베이스에 대한 부하를 줄이기 위해 굳이 관계형 데이터 베이스가 요구되지 않는 기능들은 NoSQL로 이전하였습니다.
          - ![image](https://github.com/mjs1995/Book_review/assets/47103479/9887fea7-9924-4230-8514-ace239311ff2)
- 백만 사용자, 그리고 그 이상 
  - 시스템 규모 확장을 위해 살펴본 기법들 
    - 웹 계층은 무상태 계층으로
    - 모든 계층에 다중화 도입
    - 가능한 한 많은 데이터를 캐시할 것
    - 여러 데이터 센터를 지원할 것
    - 정적 콘텐츠는 CDN을 통해 서비스할 것 
    - 데이터 계층은 샤딩을 통해 그 규모를 확장할 것 
    - 각 계층은 독립적 서비스로 분할할 것
    - 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것 
